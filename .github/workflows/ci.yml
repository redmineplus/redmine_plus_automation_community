name: Redmine Plugin CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: redmine
  MYSQL_USER: redmine
  MYSQL_PASSWORD: redmine
  REDMINE_DB_ADAPTER: mysql2
  REDMINE_DB_HOST: mysql
  REDMINE_DB_PORT: 3307
  REDMINE_DB_DATABASE: redmine
  REDMINE_DB_USERNAME: redmine
  REDMINE_DB_PASSWORD: redmine
  PLUGIN_DIR: /usr/src/redmine/plugins/redmine_plus_automation_community
  REDMINE_SECRET_KEY_BASE: fa0257bdcf409dfacec9462c72ec1248484357ab9ec5ebd2403ce44a8bd313835122e1c762f5984a45ca72a82c2638b86aa7eea5a2b936d62af22e64eaac1453

jobs:
  # ========================
  # Redmine 5 - RSpec
  # ========================
  redmine5_rspec:
    name: Redmine 5 - RSpec
    runs-on: ubuntu-latest
    container:
      image: docker:24.0.5-dind
      options: --privileged

    steps:
      - name: Install docker-cli
        run: apk add --no-cache docker-cli bash curl

      - uses: actions/checkout@v4

      - name: Start MySQL 8
        run: |
          docker network create redmine-network
          docker run -d --name mysql --network redmine-network \
            -e MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD \
            -e MYSQL_DATABASE=$MYSQL_DATABASE \
            -e MYSQL_USER=$MYSQL_USER \
            -e MYSQL_PASSWORD=$MYSQL_PASSWORD \
            -p 3307:3306 mysql:8

      - name: Wait for MySQL
        run: until docker exec mysql mysqladmin ping -hlocalhost --silent; do sleep 2; done

      - name: Start Redmine 5
        run: |
          docker run -d --name redmine -e RAILS_ENV=test --network redmine-network \
            -e REDMINE_DB_ADAPTER=$REDMINE_DB_ADAPTER \
            -e REDMINE_DB_HOST=$REDMINE_DB_HOST \
            -e REDMINE_DB_PORT=$REDMINE_DB_PORT \
            -e REDMINE_DB_DATABASE=$REDMINE_DB_DATABASE \
            -e REDMINE_DB_USERNAME=$REDMINE_DB_USERNAME \
            -e REDMINE_DB_PASSWORD=$REDMINE_DB_PASSWORD \
            -e REDMINE_SECRET_KEY_BASE=$REDMINE_SECRET_KEY_BASE \
            -p 3000:3000 redmine:5.1.6
          sleep 15

      - name: Install dependencies
        run: docker exec redmine bash -c "apt-get update && apt-get install -y curl build-essential gcc g++ make libnss3 libgtk-3-0"

      - name: Copy plugin
        run: |
          docker exec redmine mkdir -p /usr/src/redmine/plugins
          docker cp . redmine:$PLUGIN_DIR

      - name: Run RSpec
        run: |
          mkdir -p artifacts
          docker exec redmine bash -c "cd /usr/src/redmine && bundle install --with development test" > artifacts/bundle_install.log 2>&1
          docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rake redmine:plugins:migrate RAILS_ENV=test" > artifacts/migrate.log 2>&1
          docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rspec -Iplugins/redmine_plus_automation_community/spec plugins/redmine_plus_automation_community/spec" > artifacts/rspec.log 2>&1

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rspec-redmine5-logs
          path: artifacts

      - name: Cleanup
        if: always()
        run: |
          docker stop redmine mysql || true
          docker rm redmine mysql || true
          docker network rm redmine-network || true

  # ========================
  # Redmine 6 - RSpec
  # ========================
  redmine6_rspec:
    name: Redmine 6 - RSpec
    runs-on: ubuntu-latest
    container:
      image: docker:24.0.5-dind
      options: --privileged

    steps:
      - name: Install docker-cli
        run: apk add --no-cache docker-cli bash curl

      - uses: actions/checkout@v4

      - name: Run RSpec in Redmine 6
        run: |
          mkdir -p artifacts
          docker network create redmine-network
          docker run -d --name mysql --network redmine-network \
            -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=redmine -e MYSQL_USER=redmine -e MYSQL_PASSWORD=redmine \
            -p 3307:3306 mysql:8
          until docker exec mysql mysqladmin ping -hlocalhost --silent; do sleep 2; done
          docker run -d --name redmine --network redmine-network -p 3000:3000 \
            -e RAILS_ENV=test -e REDMINE_DB_ADAPTER=mysql2 -e REDMINE_DB_HOST=mysql -e REDMINE_DB_PORT=3307 \
            -e REDMINE_DB_DATABASE=redmine -e REDMINE_DB_USERNAME=redmine -e REDMINE_DB_PASSWORD=redmine \
            redmine:6.0.6
          sleep 15
          docker exec redmine bash -c "apt-get update && apt-get install -y curl build-essential gcc g++ make libnss3 libgtk-3-0"
          docker exec redmine mkdir -p /usr/src/redmine/plugins
          docker cp . redmine:/usr/src/redmine/plugins/redmine_plus_automation_community
          docker exec redmine bash -c "cd /usr/src/redmine && bundle install --with development test" > artifacts/bundle_install.log 2>&1
          docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rake redmine:plugins:migrate RAILS_ENV=test" > artifacts/migrate.log 2>&1
          docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rspec -Iplugins/redmine_plus_automation_community/spec plugins/redmine_plus_automation_community/spec" > artifacts/rspec.log 2>&1
          docker stop redmine mysql
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rspec-redmine6-logs
          path: artifacts

  # ========================
  # Redmine E2E (Cypress)
  # ========================
  e2e:
    name: Redmine E2E (Cypress)
    runs-on: ubuntu-latest
    container:
      image: docker:24.0.5-dind
      options: --privileged
    strategy:
      matrix:
        redmine_version: [5.1.6, 6.0.6]

    steps:
      - name: Install docker-cli
        run: apk add --no-cache docker-cli bash curl

      - uses: actions/checkout@v4

      - name: Setup MySQL and Redmine
        run: |
          docker network create redmine-network
          docker run -d --name mysql --network redmine-network \
            -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=redmine -e MYSQL_USER=redmine -e MYSQL_PASSWORD=redmine \
            -p 3307:3306 mysql:8
          until docker exec mysql mysqladmin ping -hlocalhost --silent; do sleep 2; done
          docker run -d --name redmine --network redmine-network -p 3000:3000 \
            -e REDMINE_DB_ADAPTER=mysql2 -e REDMINE_DB_HOST=mysql -e REDMINE_DB_PORT=3307 \
            -e REDMINE_DB_DATABASE=redmine -e REDMINE_DB_USERNAME=redmine -e REDMINE_DB_PASSWORD=redmine \
            redmine:${{ matrix.redmine_version }}
          sleep 25
          docker exec redmine bash -c "apt-get update && apt-get install -y curl xvfb nodejs npm libnss3 libgtk-3-0"

      - name: Copy plugin & setup Redmine
        run: |
          docker exec redmine mkdir -p /usr/src/redmine/plugins
          docker cp . redmine:/usr/src/redmine/plugins/redmine_plus_automation_community
          docker exec redmine bash -c "cd /usr/src/redmine && bundle install"
          docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rake redmine:plugins:migrate RAILS_ENV=production"
          docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rake redmine:load_default_data REDMINE_LANG=en RAILS_ENV=production"

      - name: Seed Redmine database
        run: |
          docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rails runner -e production 'User.create!(login:\"test\", password:\"12345678\", admin:true, firstname:\"Test\", lastname:\"User\", mail:\"test@test.com\")'"
          docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rails runner -e production 'project = Project.create!(name:\"Test Project 1\", identifier:\"test-project-1\", trackers:Tracker.all); project.enable_module!(\"automation_rules\")'"

      - name: Run Cypress
        run: |
          mkdir -p artifacts/cypress
          docker exec redmine bash -c "export DISPLAY=:99 && Xvfb :99 -screen 0 1920x1080x24 &"
          docker exec redmine bash -c "cd /usr/src/redmine/plugins/redmine_plus_automation_community && npm install && npx cypress run --e2e" > artifacts/cypress/run.log 2>&1
          docker cp redmine:/usr/src/redmine/plugins/redmine_plus_automation_community/cypress/videos artifacts/cypress/videos || true
          docker cp redmine:/usr/src/redmine/plugins/redmine_plus_automation_community/cypress/screenshots artifacts/cypress/screenshots || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-redmine${{ matrix.redmine_version }}-artifacts
          path: artifacts/cypress

      - name: Cleanup
        if: always()
        run: |
          docker stop redmine mysql || true
          docker rm redmine mysql || true
          docker network rm redmine-network || true