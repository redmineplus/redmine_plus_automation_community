redmine_5_rspec:
  stage: Redmine 5 specs
  script:
    - echo "Starting MySQL 8..."
    - docker network create redmine-network
    - |
      docker run -d --name mysql --network redmine-network \
        -e MYSQL_ROOT_PASSWORD="${MYSQL_ROOT_PASSWORD}" \
        -e MYSQL_DATABASE="${MYSQL_DATABASE}" \
        -e MYSQL_USER="${MYSQL_USER}" \
        -e MYSQL_PASSWORD="${MYSQL_PASSWORD}" \
        -p 3307:3306 mysql:8

    - echo "Waiting for MySQL to be ready..."
    - until docker exec mysql mysqladmin ping -h"localhost" --silent; do sleep 2; done

    - echo "Starting Redmine..."
    - |
      docker run -d --name redmine -e RAILS_ENV=test --network redmine-network -p 3000:3000 \
        -e REDMINE_DB_ADAPTER="${REDMINE_DB_ADAPTER}" \
        -e REDMINE_DB_HOST="${REDMINE_DB_HOST}" \
        -e REDMINE_DB_PORT="${REDMINE_DB_PORT}" \
        -e REDMINE_DB_DATABASE="${REDMINE_DB_DATABASE}" \
        -e REDMINE_DB_USERNAME="${REDMINE_DB_USERNAME}" \
        -e REDMINE_DB_PASSWORD="${REDMINE_DB_PASSWORD}" \
        -e REDMINE_SECRET_KEY_BASE="${REDMINE_SECRET_KEY_BASE}" \
        redmine:5.1.6
    #      docker run -d --name redmine --network redmine-network -p 3000:3000 \
    #        redmine:5.1.6

    - sleep 10

    # Install curl (needed to download Node.js)
    - echo "Installing curl..."
    - docker exec redmine bash -c "apt-get update && apt-get install -y curl"

    # Install required dependencies for Cypress
    - echo "Installing required system libraries..."
    - docker exec redmine bash -c "apt-get update && apt-get install -y libnss3 libgtk-3-0 libgbm-dev libasound2 libatk-bridge2.0-0 libxcomposite1 libxrandr2 libxdamage1 libxi6 libxcursor1 libxss1 libxtst6 libz-dev build-essential gcc g++ make"

    # Clone the current repository (using CI_PROJECT_DIR)
    - echo "Cloning the current repository..."
    - cp -R $CI_PROJECT_DIR /tmp/redmine_plus_automation_community

    # Ensure the plugins directory exists in the Redmine container
    - echo "Creating plugins directory in Redmine container..."
    - docker exec redmine mkdir -p /usr/src/redmine/plugins

    # Copy the cloned repository into the Redmine container's plugin folder
    - echo "Copying plugin to Redmine container..."
    - docker cp /tmp/redmine_plus_automation_community redmine:$PLUGIN_DIR

    #    # Install Redmine dependencies
    #    - echo "Installing Redmine dependencies..."
    #    - docker exec redmine bash -c "cd /usr/src/redmine && bundle install"

    # Restart Redmine to apply changes
    - echo "Bundle install and migrations..."
    - docker exec redmine bash -c "cd /usr/src/redmine && bundle install --with development test"
    - docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rake redmine:plugins:migrate RAILS_ENV=test"


    # Run Rspec tests
    - echo "Running Rspec tests..."
    - docker exec redmine bash -c "cd /usr/src/redmine && bundle exec rspec -Iplugins/redmine_plus_automation_community/spec plugins/redmine_plus_automation_community/spec"

  after_script:
    - echo "Cleaning up..."
    - docker stop redmine mysql || true
    - docker rm redmine mysql || true
    - docker network rm redmine-network || true
    - rm -rf /tmp/redmine_plus_automation_community
